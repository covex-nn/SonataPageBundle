/*
 * This file is part of the Sonata Project package.
 *
 * (c) Thomas Rabaix <thomas.rabaix@sonata-project.org>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */
!function(e,t){function n(e){"undefined"==typeof t.admin&&Admin.shared_setup(e)}var o=function(t,n){var o=n||{};this.pageId=t,this.$container=e(".page-composer"),this.$dynamicArea=e(".page-composer__dyn-content"),this.$pagePreview=e(".page-composer__page-preview"),this.$containerPreviews=this.$pagePreview.find(".page-composer__page-preview__container"),this.routes=e.extend({},o.routes||{}),this.translations=e.extend({},o.translations||{}),this.csrfTokens=e.extend({},o.csrfTokens||{}),this.bindPagePreviewHandlers(),this.bindOrphansHandlers();var a=this,i=e(this);i.on("containerclick",function(e){a.loadContainer(e.$container)}),i.on("containerloaded",this.handleContainerLoaded),i.on("blockcreated",this.handleBlockCreated),i.on("blockremoved",this.handleBlockRemoved),i.on("blockcreateformloaded",this.handleBlockCreateFormLoaded),i.on("blockpositionsupdate",this.handleBlockPositionsUpdate),i.on("blockeditformloaded",this.handleBlockEditFormLoaded),i.on("blockparentswitched",this.handleBlockParentSwitched)};o.prototype={translate:function(e){return this.translations[e]?this.translations[e]:e},getRouteUrl:function(e,t){if(!this.routes[e])throw new Error('Route "'+e+'" does not exist');var n=this.routes[e];for(var o in t)n=n.replace(new RegExp(o),t[o]);return n},isFormControlTypeByName:function(e,t){if("undefined"!=typeof e){var n=e.length,o="["+t+"]",a=e.lastIndexOf(o),n=n-o.length;return a!==-1&&a===n}return!1},handleBlockCreated:function(t){var n=this;e.ajax({url:this.getRouteUrl("block_preview",{BLOCK_ID:t.blockId}),type:"GET",success:function(o){var a=e(o);t.$childBlock.replaceWith(a),n.controlChildBlock(a);var i=n.getContainerChildCountFromList(t.parentId);null!==i&&n.updateChildCount(t.parentId,i)},error:function(){n.containerNotification("composer_preview_error","error",!0)}})},handleBlockRemoved:function(e){var t=this.getContainerChildCountFromList(e.parentId);null!==t&&this.updateChildCount(e.parentId,t)},containerNotification:function(t,n,o){var a=this.$dynamicArea.find(".page-composer__container__view__notice");if(1===a.length)if(this.containerNotificationTimer&&clearTimeout(this.containerNotificationTimer),a.removeClass("persist success error"),n&&a.addClass(n),a.text(this.translate(t)),a.show(),o!==!0)this.containerNotificationTimer=setTimeout(function(){a.hide().empty()},2e3);else{var i=e('<span class="close-notice">x</span>');i.on("click",function(){a.hide().empty()}),a.addClass("persist"),a.append(i)}},handleBlockPositionsUpdate:function(t){var n=this;this.containerNotification("composer_update_saving"),e.ajax({url:this.getRouteUrl("save_blocks_positions"),type:"POST",data:{disposition:t.disposition},success:function(e){e.result&&"ok"===e.result&&n.containerNotification("composer_update_saved","success")},error:function(){n.containerNotification("composer_update_error","error",!0)}})},handleBlockParentSwitched:function(t){var n=e(".block-preview-"+t.previousParentId),o=n.find(".child-count"),a=parseInt(o.text().trim(),10),i=e(".block-preview-"+t.newParentId),r=i.find(".child-count"),c=parseInt(r.text().trim(),10);this.updateChildCount(t.previousParentId,a-1),this.updateChildCount(t.newParentId,c+1)},getContainerChildCountFromList:function(t){var n=this.$dynamicArea.find(".block-view-"+t);if(0===n.length)return null;var o=n.find(".page-composer__container__child"),a=0;return o.each(function(){var t=e(this),n=t.attr("data-block-id");"undefined"!=typeof n&&a++}),a},updateChildCount:function(t,n){var o=e(".block-preview-"+t),a=e(".block-view-"+t);o.length>0&&o.find(".child-count").text(n),a.length>0&&a.find(".page-composer__container__child-count span").text(n)},handleBlockCreateFormLoaded:function(t){var o=this,a=this.$dynamicArea.find(".page-composer__container__children"),i=this.$dynamicArea.find(".page-composer__container__main-edition-area");if(t.container){var r=t.container,c=r.find(".page-composer__container__child__content");c.html(t.response)}else{var r=e(['<li class="page-composer__container__child">','<a class="page-composer__container__child__edit">','<h4 class="page-composer__container__child__name">','<input type="text" class="page-composer__container__child__name__input">',"</h4>","</a>",'<div class="page-composer__container__child__right">','<span class="badge">'+t.blockTypeLabel+"</span>","</div>",'<div class="page-composer__container__child__content">',"</div>","</li>"].join("")),c=r.find(".page-composer__container__child__content");c.append(t.response),a.append(r),c.show()}var s,d,l,p=r.find("form"),_=p.attr("action"),h=(p.attr("method"),p.find("input, select, textarea")),m=p.find(".form-actions"),u=this.$dynamicArea.find(".page-composer__container__child__name");n(p),e(document).scrollTo(r,200),i.show(),h.each(function(){var n=e(this),i=n.attr("name");o.isFormControlTypeByName(i,"name")?(s=n,u.find(".page-composer__container__child__name__input").bind("propertychange keyup input paste",function(t){s.val(e(this).val())})):o.isFormControlTypeByName(i,"parent")?(d=n,d.val(t.containerId),d.parent().parent().hide()):o.isFormControlTypeByName(i,"position")&&(l=n,l.val(a.find("> *").length),l.closest(".form-group").hide())}),m.each(function(){var t=e(this),n=e('<span class="btn btn-warning">'+o.translate("cancel")+"</span>");n.on("click",function(t){t.preventDefault(),r.remove(),e(document).scrollTo(o.$dynamicArea,200)}),t.append(n)}),p.on("submit",function(a){var i=s.val();return""===i&&(i=t.blockType),p.attr("action",_+"&"+e.param({composer:1})),o.retargetAjaxForm(p,function(a){if(a.result&&"ok"===a.result&&a.objectId){var s=e.Event("blockcreated");s.$childBlock=r,s.parentId=t.containerId,s.blockId=a.objectId,s.blockName=i,s.blockType=t.blockType,e(o).trigger(s)}else{var d=e.Event("blockcreateformloaded");d.response=a,d.containerId=t.containerId,d.blockType=t.blockType,d.container=r,e(o).trigger(d),n(c)}})})},toggleChildBlock:function(e){var t="page-composer__container__child--expanded",n=this.$dynamicArea.find(".page-composer__container__child"),o=e.find(".page-composer__container__child__name"),a=o.find(".page-composer__container__child__name__input");e.hasClass(t)?(e.removeClass(t),o.has(".page-composer__container__child__name__input")&&o.html(a.val())):(n.not(e).removeClass(t),e.addClass(t))},handleBlockEditFormLoaded:function(t){var o,a,i=this,r=t.$block.find(".page-composer__container__child__edit h4"),c=t.$block.find(".page-composer__container__child__content"),s=t.$block.find(".page-composer__container__child__loader"),d=c.find("form"),l=(d.attr("action"),d.attr("method"),t.$block.find(".page-composer__container__child__edit small").text().trim());d.find("input").each(function(){var t=e(this),n=t.attr("name");i.isFormControlTypeByName(n,"name")?(o=t,r.html('<input type="text" class="page-composer__container__child__name__input" value="'+r.text()+'">'),$input=r.find("input"),$input.bind("propertychange keyup input paste",function(e){o.val($input.val())}),$input.on("click",function(e){e.stopPropagation(),e.preventDefault()})):i.isFormControlTypeByName(n,"position")&&(a=t,a.closest(".form-group").hide())}),d.on("submit",function(a){return s.show(),i.retargetAjaxForm(d,function(a){if(s.hide(),a.result&&"ok"===a.result)"undefined"!=typeof o&&r.text(""!==o.val()?o.val():l),t.$block.removeClass("page-composer__container__child--expanded"),c.empty();else{c.html(a);var d=e.Event("blockeditformloaded");d.$block=t.$block,e(i).trigger(d),n(c)}})})},controlChildBlock:function(t){var o=this,a=t.find(".page-composer__container__child__content"),i=t.find(".page-composer__container__child__loader"),r=t.find(".page-composer__container__child__edit"),c=r.attr("href"),s=t.find(".page-composer__container__child__remove"),d=s.find("a"),l=t.find(".page-composer__container__child__switch-enabled"),p=l.attr("data-label-enable"),_=l.attr("data-label-disable"),h=l.find("a"),m=h.find("i"),u=t.find(".page-composer__container__child__enabled"),f=u.find("small"),g=u.find("i"),v=h.attr("href"),b=parseInt(t.attr("data-block-enabled"),2);r.click(function(r){return r.preventDefault(),a.find("form").length>0?void o.toggleChildBlock(t):(i.show(),void e.ajax({url:c,success:function(r){a.html(r);var c=e.Event("blockeditformloaded");c.$block=t,e(o).trigger(c),n(a),i.hide(),o.toggleChildBlock(t)}}))}),h.on("click",function(n){n.preventDefault(),e.ajax({url:v,type:"POST",data:{_sonata_csrf_token:o.csrfTokens.switchEnabled,value:!b},success:function(n){if(t.attr("data-block-enabled",b?"0":"1"),b=!b,h.toggleClass("bg-yellow bg-green"),m.toggleClass("fa-toggle-off fa-toggle-on"),b?h.html(_):h.html(p),f.toggleClass("bg-yellow bg-green"),g.toggleClass("fa-times fa-check"),t.has("form")){var a=t.find("form"),i=a.find("input");i.each(function(){var t=e(this),n=t.attr("name");o.isFormControlTypeByName(n,"enabled")&&t.val(parseInt(!b))})}},error:function(){o.containerNotification("composer_status_error","error",!0)}})}),d.on("click",function(e){e.preventDefault(),o.confirmRemoveContainer(t)})},confirmRemoveContainer:function(t){var n=this,o=t.find(".page-composer__container__child__remove"),a=o.find("a"),i=t.find(".page-composer__container__child__remove__dialog"),r=a.attr("href"),c=parseInt(t.attr("data-parent-block-id"),10);0==i.length&&(i=e(['<div class="modal fade page-composer__container__child__remove__dialog" tabindex="-1" role="dialog">','<div class="modal-dialog" role="document">','<div class="modal-content">','<div class="modal-header">','<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>','<h4 class="modal-title">'+this.translate("composer_remove_confirm")+"</h4>","</div>",'<div class="modal-body">',"</div>",'<div class="modal-footer">','<button type="button" class="btn btn-default" data-dismiss="modal">'+this.translate("cancel")+"</button>",'<button type="button" class="btn btn-primary">'+this.translate("yes")+"</button>","</div>","</div>","</div>","</div>"].join("")),t.append(i));var s=i.find(".btn-primary");s.on("click",function(o){e.ajax({url:r,type:"POST",data:{_method:"DELETE",_sonata_csrf_token:n.csrfTokens.remove},success:function(o){if(o.result&&"ok"===o.result){t.remove();var a=e.Event("blockremoved");a.parentId=c,e(n).trigger(a)}}}),i.modal("hide"),0!=e(".modal-backdrop").length&&e(".modal-backdrop").hide()}),i.modal("show")},handleContainerLoaded:function(t){var o=this,a=this.$dynamicArea.find(".page-composer__container__children"),i=this.$dynamicArea.find(".page-composer__container__child"),r=this.$dynamicArea.find(".page-composer__block-type-selector"),c=r.find(".page-composer__block-type-selector__loader"),s=r.find("select"),d=r.find(".page-composer__block-type-selector__confirm"),l=d.attr("href");n(this.$dynamicArea),d.on("click",function(n){n.preventDefault(),c.css("display","inline-block");var a=s.val(),i=s.find("option:selected").text();e.ajax({url:l,data:{type:a},success:function(n){c.hide(),e(o).trigger(e.Event("blockcreateformloaded",{response:n,containerId:t.containerId,blockType:a,blockTypeLabel:i}))}})}),a.sortable({revert:!0,cursor:"move",revertDuration:200,delay:200,helper:function(t,n){var o=e(n),a=o.find(".page-composer__container__child__edit h4").text().trim();o.find(".page-composer__container__child__edit small").text().trim();return o.removeClass("page-composer__container__child--expanded"),e('<div class="page-composer__container__child__helper"><h4>'+a+"</h4></div>")},update:function(t,n){var i=[];if(a.find(".page-composer__container__child").each(function(t){var n=e(this),a=n.attr("data-parent-block-id"),r=n.attr("data-block-id");"undefined"!=typeof r&&i.push({id:parseInt(r,10),position:t,parent_id:parseInt(a,10),page_id:o.pageId})}),i.length>0){var r=e.Event("blockpositionsupdate");r.disposition=i,e(o).trigger(r)}}}),i.each(function(){o.controlChildBlock(e(this))})},bindPagePreviewHandlers:function(){var t=this;this.$containerPreviews.each(function(){var n=e(this);n.on("click",function(o){o.preventDefault();var a=e.Event("containerclick");a.$container=n,e(t).trigger(a)})}).droppable({hoverClass:"hover",tolerance:"pointer",revert:!0,connectToSortable:".page-composer__container__children",accept:function(t){var n=e(this).attr("data-block-whitelist");if(""===n)return!0;n=n.split(",");var o=e(t).attr("data-block-type");return n.indexOf(o)!==-1},drop:function(n,o){var a=o.draggable.attr("data-block-id");if("undefined"!=typeof a){o.helper.remove();var i=e(this),r=parseInt(o.draggable.attr("data-parent-block-id"),10),c=parseInt(i.attr("data-block-id"),10);a=parseInt(a,10),r!==c&&(i.addClass("dropped"),i.on("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(e){i.removeClass("dropped")}),e.ajax({url:t.getRouteUrl("block_switch_parent"),data:{block_id:a,parent_id:c},success:function(n){if(n.result&&"ok"===n.result){o.draggable.remove();var i=e.Event("blockparentswitched");i.previousParentId=r,i.newParentId=c,i.blockId=a,e(t).trigger(i)}}}))}}}),this.$containerPreviews.length>0&&this.loadContainer(this.$containerPreviews.eq(0))},bindOrphansHandlers:function(){var t=this;this.$container.find(".page-composer__orphan-container").each(function(){var n=e(this);n.on("click",function(o){o.preventDefault();var a=e.Event("containerclick");a.$container=n,e(t).trigger(a)})})},loadContainer:function(t){var n=t.attr("href"),o=t.attr("data-block-id"),a=this;this.$dynamicArea.empty(),this.$containerPreviews.removeClass("active"),this.$container.find(".page-composer__orphan-container").removeClass("active"),t.addClass("active"),e.ajax({url:n,success:function(t){a.$dynamicArea.html(t),e(document).scrollTo(a.$dynamicArea,200,{offset:{top:-100}});var n=e.Event("containerloaded");n.containerId=o,e(a).trigger(n)}})},retargetAjaxForm:function(t,n){var o=e('<iframe style="display:none;"></iframe>').attr("name","retarget__"+Math.floor(999999*Math.random())).appendTo(e("body")).load(function(){var t,a=o[0].contentDocument.documentElement;try{t=e.parseJSON(a.innerText)}catch(i){t=a.outerHTML}n(t),o.remove()});return t.append('<input type="hidden" name="_xml_http_request" value="1"/>').attr("target",o.attr("name")),!0}},t.PageComposer=o,e(function(){e("[data-page-composer]").each(function(){var t=e(this).data("page-composer");new o(t.pageId,t)})})}(jQuery,window),function(e,t,n,o){function a(t,n){this.element=t,this.options=e.extend({},c,n),this._defaults=c,this._name=i,this.init()}var i="treeView",r=".js-treeview",c={togglersAttribute:"[data-treeview-toggler]",toggledState:"is-toggled"};a.prototype={init:function(){this.setElements(),this.setEvents()},setElements:function(){this.$element=e(this.element),this.$togglers=this.$element.find(this.options.togglersAttribute)},setEvents:function(){this.$togglers.on("click",e.proxy(this.toggle,this))},toggle:function(t){var n=e(t.currentTarget),o=n.parent();o.toggleClass(this.options.toggledState),o.next("ul").slideToggle()}},e.fn[i]=function(t){return this.each(function(){e.data(this,"plugin_"+i)||e.data(this,"plugin_"+i,new a(this,t))})},e(function(){e(r)[i]()})}(jQuery,window,document);